<nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
  <div class="container" bis_skin_checked="1">

    <a class="navbar-brand d-flex align-items-center" routerLink="/dashboard">
      <img src="logo.png" alt="NutriZulia Logo" width="50" height="50" class="me-2">
      NutriZulia
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarColor01" bis_skin_checked="1">
      <ul class="navbar-nav flex-grow-1 justify-content-center align-items-center">
        <li class="nav-item">
          <a class="nav-link" routerLink="/dashboard" routerLinkActive="active">Inicio
            <span class="visually-hidden">(current)</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/users" routerLinkActive="active">Usuarios</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/institutions" routerLinkActive="active">Instituciones</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/reports" routerLinkActive="active">Reportes</a>
        </li>
      </ul>

      <!-- Dropdown de usuario -->
      <div class="dropdown mx-auto mx-lg-0 ms-lg-auto my-2 my-lg-0">
        <a href="#" class="d-flex align-items-center justify-content-center justify-content-lg-start text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle text-light me-2 fs-4"></i>
          <span class="text-light d-sm-inline">{{ userShortName }}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end text-small shadow" data-bs-theme="light">
          <li class="px-3 py-2">
            <div class="user-info">
              <div class="fw-semibold">{{ userFullName }}</div>
              <div class="text-muted small">{{ userEmail }}</div>
              <div class="small mt-2">
                <span class="text-muted">Cédula:</span> {{ userCedula }}
              </div>
              <div class="small mt-1">
                <span class="text-muted">Roles:</span>
                <span *ngIf="displayedRoles?.length; else noRoles"> {{ displayedRoles.join(', ') }}</span>
                <ng-template #noRoles><span class="text-muted">Sin roles</span></ng-template>
              </div>
            </div>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" (click)="changePassword()">Cambiar contraseña</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <button class="dropdown-item text-danger" type="button" (click)="showLogoutModal()">
              Cerrar sesión
            </button>
          </li>
        </ul>
      </div>
      <!-- Fin dropdown de usuario -->

      <!-- Modal de confirmación de cierre de sesión -->
      <div class="modal fade" id="logoutConfirmModal" tabindex="-1" aria-labelledby="logoutConfirmLabel" aria-hidden="true" data-bs-theme="light">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="logoutConfirmLabel">Cerrar sesión</h5>
              <button type="button" class="btn-close" [disabled]="isLoggingOut" (click)="hideLogoutModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              ¿Desea cerrar sesión?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" [disabled]="isLoggingOut" (click)="hideLogoutModal()">Cancelar</button>
              <button type="button" class="btn btn-danger" [disabled]="isLoggingOut" (click)="confirmLogout()">
                <span class="spinner-border spinner-border-sm me-2 text-light" *ngIf="isLoggingOut" role="status" aria-hidden="true"></span>
                Cerrar sesión
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Fin modal de confirmación -->
      <!-- Modal cambio de contraseña -->
      <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordLabel" aria-hidden="true" data-bs-theme="light">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="changePasswordLabel">Cambiar contraseña</h5>
              <button type="button" class="btn-close" [disabled]="isChangingPassword" (click)="hideChangePasswordModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form [formGroup]="changePasswordForm" (ngSubmit)="submitChangePassword()">
                <div class="mb-3">
                  <label for="clave_actual" class="form-label">Contraseña actual</label>
                  <input id="clave_actual" type="password" class="form-control" formControlName="clave_actual" [class.is-invalid]="hasChangePasswordFieldError('clave_actual')" autocomplete="current-password">
                  <div class="invalid-feedback" *ngIf="hasChangePasswordFieldError('clave_actual')">
                    {{ getChangePasswordFieldError('clave_actual') }}
                  </div>
                </div>

                <div class="mb-3">
                  <label for="clave_nueva" class="form-label">Nueva contraseña</label>
                  <input id="clave_nueva" type="password" class="form-control" formControlName="clave_nueva" [class.is-invalid]="hasChangePasswordFieldError('clave_nueva')" autocomplete="new-password">
                  <div class="form-text">
                    Debe tener al menos 8 caracteres, incluir mayúscula, minúscula, número y carácter especial (&#64;$!%*?&).
                  </div>
                  <div class="invalid-feedback" *ngIf="hasChangePasswordFieldError('clave_nueva')">
                    {{ getChangePasswordFieldError('clave_nueva') }}
                  </div>
                </div>

                <div class="mb-3">
                  <label for="clave_nueva_confirmacion" class="form-label">Confirmar nueva contraseña</label>
                  <input id="clave_nueva_confirmacion" type="password" class="form-control" formControlName="clave_nueva_confirmacion" [class.is-invalid]="hasChangePasswordFieldError('clave_nueva_confirmacion')" autocomplete="new-password">
                  <div class="invalid-feedback" *ngIf="hasChangePasswordFieldError('clave_nueva_confirmacion')">
                    {{ getChangePasswordFieldError('clave_nueva_confirmacion') }}
                  </div>
                </div>

                <div class="modal-footer px-0">
                  <button type="button" class="btn btn-outline-secondary" [disabled]="isChangingPassword" (click)="hideChangePasswordModal()">Cancelar</button>
                  <button type="submit" class="btn btn-primary" [disabled]="isChangingPassword || changePasswordForm.invalid">
                    <span class="spinner-border spinner-border-sm me-2 text-light" *ngIf="isChangingPassword" role="status" aria-hidden="true"></span>
                    Cambiar contraseña
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- Fin modal cambio de contraseña -->
    </div>
  </div>
</nav>
