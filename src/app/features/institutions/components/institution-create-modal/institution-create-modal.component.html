<!-- Modal Backdrop -->
<div class="modal fade"
     [class.show]="show"
     [style.display]="show ? 'block' : 'none'"
     tabindex="-1"
     role="dialog"
     aria-labelledby="createInstitutionModalLabel"
     aria-hidden="!show">

  <!-- Componente de notificación -->
  <app-notification
    [notification]="notificationService.notification()"
    (dismissed)="notificationService.hide()">
  </app-notification>

  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="createInstitutionModalLabel">
          <i class="bi bi-building-add me-2"></i>
          Crear Nueva Institución
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                aria-label="Cerrar"
                [disabled]="submitting()"
                (click)="onClose()">
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">

        <!-- Form -->
        <form [formGroup]="institutionForm" (ngSubmit)="onSubmit()" novalidate>

          <!-- Información de la Institución -->
          <div class="row">
            <div class="col-12">
              <h6 class="text-muted mb-3">Información de la Institución</h6>
            </div>
          </div>

          <!-- Nombre de la Institución -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  formControlName="nombre"
                  placeholder="Nombre de la institución"
                  [class.is-invalid]="isFieldInvalid('nombre')">
                <label for="nombre">Nombre de la Institución <span class="text-danger">*</span></label>
              </div>
              <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('nombre')">
                {{ getFieldError('nombre') }}
              </div>
            </div>
          </div>

          <!-- Tipo de Institución y Municipio Sanitario -->
          <div class="row mb-3">
            <!-- Tipo de Institución -->
            <div class="col-md-6">
              <div class="form-floating">
                <select
                  class="form-select"
                  id="tipoInstitucion"
                  formControlName="tipo_institucion_id"
                  [class.is-invalid]="isFieldInvalid('tipo_institucion_id')">
                  <option value="" disabled>Seleccione un tipo</option>
                  @for (tipo of tiposInstituciones(); track tipo.id) {
                    <option [value]="tipo.id">{{ tipo.nombre }}</option>
                  }
                </select>
                <label for="tipoInstitucion">Tipo de Institución <span class="text-danger">*</span></label>
                <!-- Indicador de carga para tipos -->
                @if (loadingTipos()) {
                  <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Cargando...</span>
                    </div>
                  </div>
                }
              </div>
              <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('tipo_institucion_id')">
                {{ getFieldError('tipo_institucion_id') }}
              </div>
            </div>

            <!-- Municipio Sanitario -->
            <div class="col-md-6">
              <div class="form-floating">
                <select
                  class="form-select"
                  id="municipioSanitario"
                  formControlName="municipio_sanitario_id"
                  [class.is-invalid]="isFieldInvalid('municipio_sanitario_id')">
                  <option value="" disabled>Seleccione un municipio</option>
                  @for (municipio of municipiosSanitarios(); track municipio.id) {
                    <option [value]="municipio.id">{{ municipio.nombre }}</option>
                  }
                </select>
                <label for="municipioSanitario">Municipio Sanitario <span class="text-danger">*</span></label>
                <!-- Indicador de carga para municipios -->
                @if (loadingMunicipios()) {
                  <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Cargando...</span>
                    </div>
                  </div>
                }
              </div>
              <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('municipio_sanitario_id')">
                {{ getFieldError('municipio_sanitario_id') }}
              </div>
            </div>
          </div>

          <!-- Información adicional -->
          <div class="row">
            <div class="col-12">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Información Importante:</strong>
                <ul class="mb-0">
                  <li>Podrá asignar usuarios después de la creación.</li>
                  <li>Todos los campos marcados con <span class="text-danger">*</span> son obligatorios.</li>
                </ul>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                [disabled]="submitting()"
                (click)="onClose()">
          <i class="bi bi-x-circle me-2"></i>
          Cancelar
        </button>

        <button type="submit"
                class="btn btn-primary"
                [disabled]="institutionForm.invalid || submitting()"
                (click)="onSubmit()">
          @if (submitting()) {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Creando...
          } @else {
            <i class="bi bi-check-circle me-2"></i>
            Crear Institución
          }
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal Backdrop -->
@if (show) {
  <div class="modal-backdrop fade show"></div>
}
